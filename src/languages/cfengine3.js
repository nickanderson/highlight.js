/*
Language: CFEngine3
Author: Nick Anderson <nick@cmdln.org>
Website: https://docs.cfengine.com
Category: config
*/

export default function(hljs) {
  const CFEngine3_KEYWORDS = {
    built_in_bundle_types:
    // cf-promises --syntax-description json | jq '.bundleTypes | keys' | sed s/\"/\'/g
    [
      'agent',
      'common',
      'edit_line',
      'edit_xml',
      'monitor',
      'server'
    ],

    // cf-promises --syntax-description json | jq '.promiseTypes | keys' | sed s/\"/\'/g
    built_in_promise_types:
    [
      'access',
      'build_xpath',
      'classes',
      'commands',
      'databases',
      'defaults',
      'delete_attribute',
      'delete_lines',
      'delete_text',
      'delete_tree',
      'field_edits',
      'files',
      'guest_environments',
      'insert_lines',
      'insert_text',
      'insert_tree',
      'measurements',
      'meta',
      'methods',
      'packages',
      'processes',
      'replace_patterns',
      'reports',
      'roles',
      'services',
      'set_attribute',
      'set_text',
      'storage',
      'users',
      'vars'
    ],

    // cf-promises --syntax-description json | jq '.bodyTypes | keys' | sed s/\"/\'/g
    built_in_body_types:
    [
      'acl',
      'action',
      'agent',
      'changes',
      'classes',
      'common',
      'contain',
      'copy_from',
      'database_server',
      'delete',
      'delete_select',
      'depth_search',
      'edit_defaults',
      'edit_field',
      'environment_interface',
      'environment_resources',
      'executor',
      'file',
      'file_select',
      'hub',
      'insert_select',
      'link_from',
      'location',
      'match_value',
      'monitor',
      'mount',
      'package_method',
      'package_module',
      'password',
      'perms',
      'printfile',
      'process_count',
      'process_select',
      'rename',
      'replace_with',
      'report_data_select',
      'runagent',
      'select_region',
      'server',
      'service_method',
      'volume'
    ],

    // cf-promises --syntax-description json | jq  '.promiseTypes[] | .attributes | keys' | jq -s 'add | unique'
    built_in_promise_attributes:
    [
      "acl",
      "action",
      "additional_packages",
      "admit",
      "admit_hostnames",
      "admit_ips",
      "admit_keys",
      "and",
      "architecture",
      "arglist",
      "args",
      "attribute_value",
      "authorize",
      "build_xpath",
      "bundle_return_value_index",
      "changes",
      "classes",
      "comment",
      "contain",
      "content",
      "copy_from",
      "create",
      "data",
      "data_type",
      "database_columns",
      "database_operation",
      "database_rows",
      "database_server",
      "database_type",
      "delete",
      "delete_select",
      "deny",
      "deny_hostnames",
      "deny_ips",
      "deny_keys",
      "depends_on",
      "depth_search",
      "description",
      "dist",
      "edit_defaults",
      "edit_field",
      "edit_line",
      "edit_template",
      "edit_template_string",
      "edit_xml",
      "environment_host",
      "environment_interface",
      "environment_resources",
      "environment_state",
      "environment_type",
      "expand_scalars",
      "expression",
      "file_select",
      "file_type",
      "friend_pattern",
      "group_primary",
      "groups_secondary",
      "handle",
      "history_type",
      "home_bundle",
      "home_bundle_inherit",
      "home_dir",
      "if",
      "if_match_regex",
      "ifencrypted",
      "ifvarclass",
      "ilist",
      "inform",
      "inherit",
      "insert_select",
      "insert_type",
      "int",
      "intermittency",
      "lastseen",
      "link_from",
      "location",
      "maproot",
      "match_value",
      "meta",
      "module",
      "mount",
      "move_obstructions",
      "not",
      "not_matching",
      "options",
      "or",
      "package_architectures",
      "package_method",
      "package_module",
      "package_policy",
      "package_select",
      "package_version",
      "password",
      "pathtype",
      "perms",
      "persistence",
      "policy",
      "printfile",
      "process_count",
      "process_select",
      "process_stop",
      "real",
      "registry_exclude",
      "rename",
      "replace_with",
      "report_data_select",
      "report_to_file",
      "repository",
      "resource_type",
      "restart_class",
      "rlist",
      "scope",
      "select_class",
      "select_region",
      "select_xpath",
      "service_dependencies",
      "service_method",
      "service_policy",
      "shell",
      "shortcut",
      "showstate",
      "signals",
      "slist",
      "stream_type",
      "string",
      "template_data",
      "template_method",
      "touch",
      "transformer",
      "uid",
      "units",
      "unless",
      "usebundle",
      "useresult",
      "version",
      "volume",
      "whitespace_policy",
      "with",
      "xor"
    ],

        // cf-promises --syntax-description json | jq '.functions | keys' | sed s/\"/\'/g
    built_in_functions:
    [
      'accessedbefore',
      'accumulated',
      'ago',
      'and',
      'basename',
      'bundlesmatching',
      'bundlestate',
      'callstack_callers',
      'callstack_promisers',
      'canonify',
      'canonifyuniquely',
      'cf_version_after',
      'cf_version_at',
      'cf_version_before',
      'cf_version_between',
      'cf_version_maximum',
      'cf_version_minimum',
      'changedbefore',
      'classesmatching',
      'classfiltercsv',
      'classify',
      'classmatch',
      'concat',
      'countclassesmatching',
      'countlinesmatching',
      'data_expand',
      'data_readstringarray',
      'data_readstringarrayidx',
      'data_regextract',
      'data_sysctlvalues',
      'datastate',
      'difference',
      'dirname',
      'diskfree',
      'escape',
      'eval',
      'every',
      'execresult',
      'execresult_as_data',
      'expandrange',
      'file_hash',
      'fileexists',
      'filesexist',
      'filesize',
      'filestat',
      'filter',
      'findfiles',
      'findfiles_up',
      'findprocesses',
      'format',
      'getclassmetatags',
      'getenv',
      'getfields',
      'getgid',
      'getindices',
      'getuid',
      'getuserinfo',
      'getusers',
      'getvalues',
      'getvariablemetatags',
      'grep',
      'groupexists',
      'hash',
      'hash_to_int',
      'hashmatch',
      'host2ip',
      'hostinnetgroup',
      'hostrange',
      'hostsseen',
      'hostswithclass',
      'hubknowledge',
      'ifelse',
      'int',
      'intersection',
      'ip2host',
      'iprange',
      'irange',
      'isdir',
      'isexecutable',
      'isgreaterthan',
      'isipinsubnet',
      'islessthan',
      'islink',
      'isnewerthan',
      'isplain',
      'isvariable',
      'join',
      'lastnode',
      'laterthan',
      'ldaparray',
      'ldaplist',
      'ldapvalue',
      'length',
      'lsdir',
      'makerule',
      'maparray',
      'mapdata',
      'maplist',
      'max',
      'mean',
      'mergedata',
      'min',
      'network_connections',
      'none',
      'not',
      'now',
      'nth',
      'on',
      'or',
      'packagesmatching',
      'packageupdatesmatching',
      'parseintarray',
      'parsejson',
      'parserealarray',
      'parsestringarray',
      'parsestringarrayidx',
      'parseyaml',
      'peerleader',
      'peerleaders',
      'peers',
      'processexists',
      'product',
      'randomint',
      'read_module_protocol',
      'readcsv',
      'readdata',
      'readenvfile',
      'readfile',
      'readintarray',
      'readintlist',
      'readjson',
      'readrealarray',
      'readreallist',
      'readstringarray',
      'readstringarrayidx',
      'readstringlist',
      'readtcp',
      'readyaml',
      'regarray',
      'regcmp',
      'regex_replace',
      'regextract',
      'registryvalue',
      'regldap',
      'regline',
      'reglist',
      'remoteclassesmatching',
      'remotescalar',
      'returnszero',
      'reverse',
      'rrange',
      'search_up',
      'selectservers',
      'shuffle',
      'some',
      'sort',
      'splayclass',
      'splitstring',
      'storejson',
      'strcmp',
      'strftime',
      'string',
      'string_downcase',
      'string_head',
      'string_length',
      'string_mustache',
      'string_replace',
      'string_reverse',
      'string_split',
      'string_tail',
      'string_trim',
      'string_upcase',
      'sublist',
      'sum',
      'sysctlvalue',
      'translatepath',
      'type',
      'unique',
      'url_get',
      'usemodule',
      'userexists',
      'validdata',
      'validjson',
      'variablesmatching',
      'variablesmatching_as_data',
      'variance'
    ],

    // cf-promises --syntax-description json | jq  '.bodyTypes[].attributes | keys' | jq -s 'add | unique' | sed s/\"/\'/g
    built_in_body_attributes:
    [
      'abortbundleclasses',
      'abortclasses',
      'aces',
      'acl_default',
      'acl_directory_inherit',
      'acl_inherit',
      'acl_method',
      'acl_type',
      'action_policy',
      'addclasses',
      'agent_expireafter',
      'agentaccess',
      'agentfacility',
      'allclassesreport',
      'allow_blank_fields',
      'allowallconnects',
      'allowciphers',
      'allowconnects',
      'allowlegacyconnects',
      'allowtlsversion',
      'allowusers',
      'alwaysvalidate',
      'atime',
      'audit',
      'auditing',
      'background',
      'background_children',
      'before_after',
      'bindtointerface',
      'bsdflags',
      'bundlesequence',
      'bwlimit',
      'cache_system_functions',
      'call_collect_interval',
      'cancel_kept',
      'cancel_notkept',
      'cancel_repaired',
      'cfruncommand',
      'chdir',
      'check_foreign',
      'check_root',
      'checksum_alert_time',
      'childlibpath',
      'chroot',
      'client_history_timeout',
      'collapse_destination_dir',
      'collect_window',
      'command',
      'compare',
      'copy_backup',
      'copy_patterns',
      'copy_size',
      'copyfrom_restrict_keys',
      'copylink_patterns',
      'ctime',
      'data',
      'db_server_connection_db',
      'db_server_host',
      'db_server_owner',
      'db_server_password',
      'db_server_type',
      'default_options',
      'default_repository',
      'default_timeout',
      'defaultcopytype',
      'delete_if_contains_from_list',
      'delete_if_match_from_list',
      'delete_if_not_contains_from_list',
      'delete_if_not_match_from_list',
      'delete_if_not_startwith_from_list',
      'delete_if_startwith_from_list',
      'denybadclocks',
      'denyconnects',
      'depth',
      'dirlinks',
      'disable',
      'disable_mode',
      'disable_suffix',
      'domain',
      'dryrun',
      'dynamicaddresses',
      'edit_backup',
      'edit_fstab',
      'editbinaryfilesize',
      'editfilesize',
      'empty_file_before_editing',
      'encrypt',
      'env_addresses',
      'env_baseline',
      'env_cpus',
      'env_disk',
      'env_memory',
      'env_name',
      'env_network',
      'env_spec',
      'environment',
      'exclude_dirs',
      'exclude_hosts',
      'exec_command',
      'exec_group',
      'exec_owner',
      'exec_program',
      'exec_regex',
      'exec_timeout',
      'executorfacility',
      'expireafter',
      'extend_fields',
      'extraction_regex',
      'failed_returncodes',
      'field_operation',
      'field_separator',
      'field_value',
      'file_result',
      'file_to_print',
      'file_types',
      'files_auto_define',
      'files_single_copy',
      'findertype',
      'fips_mode',
      'first_last',
      'force_ipv4',
      'force_update',
      'forgetrate',
      'format',
      'freespace',
      'goal_patterns',
      'groups',
      'hash',
      'hashupdates',
      'histograms',
      'hostnamekeys',
      'hosts',
      'hub_schedule',
      'ifelapsed',
      'ignore_missing_bundles',
      'ignore_missing_inputs',
      'in_range_define',
      'include_basedir',
      'include_dirs',
      'include_end_delimiter',
      'include_start_delimiter',
      'inform',
      'inherit',
      'inherit_from',
      'inputs',
      'insert_if_contains_from_list',
      'insert_if_match_from_list',
      'insert_if_not_contains_from_list',
      'insert_if_not_match_from_list',
      'insert_if_not_startwith_from_list',
      'insert_if_startwith_from_list',
      'intermittency',
      'interpreter',
      'issymlinkto',
      'kept_returncodes',
      'lastseenexpireafter',
      'leaf_name',
      'link_children',
      'link_type',
      'linkcopy_patterns',
      'listen',
      'log_failed',
      'log_kept',
      'log_level',
      'log_priority',
      'log_repaired',
      'log_string',
      'logallconnections',
      'logencryptedtransfers',
      'mailfilter_exclude',
      'mailfilter_include',
      'mailfrom',
      'mailmaxlines',
      'mailsubject',
      'mailto',
      'match_range',
      'max_children',
      'max_file_size',
      'maxconnections',
      'measurement_class',
      'meta',
      'metatags_exclude',
      'metatags_include',
      'missing_ok',
      'mode',
      'module_path',
      'monitorfacility',
      'monitoring_exclude',
      'monitoring_include',
      'mount_options',
      'mount_server',
      'mount_source',
      'mount_type',
      'mountfilesystems',
      'mtime',
      'namespace',
      'newname',
      'no_output',
      'nonalphanumfiles',
      'number_of_lines',
      'occurrences',
      'out_of_range_define',
      'output_directory',
      'output_prefix',
      'output_to_file',
      'owners',
      'package_add_command',
      'package_arch_regex',
      'package_changes',
      'package_commands_useshell',
      'package_default_arch_command',
      'package_delete_command',
      'package_delete_convention',
      'package_file_repositories',
      'package_installed_regex',
      'package_inventory',
      'package_list_arch_regex',
      'package_list_command',
      'package_list_name_regex',
      'package_list_update_command',
      'package_list_update_ifelapsed',
      'package_list_version_regex',
      'package_module',
      'package_multiline_start',
      'package_name_convention',
      'package_name_regex',
      'package_noverify_regex',
      'package_noverify_returncode',
      'package_patch_arch_regex',
      'package_patch_command',
      'package_patch_installed_regex',
      'package_patch_list_command',
      'package_patch_name_regex',
      'package_patch_version_regex',
      'package_update_command',
      'package_verify_command',
      'package_version_equal_command',
      'package_version_less_command',
      'package_version_regex',
      'path_name',
      'persist_time',
      'pgid',
      'pid',
      'port',
      'portnumber',
      'ppid',
      'preserve',
      'preview',
      'priority',
      'process_owner',
      'process_result',
      'promise_handle_exclude',
      'promise_handle_include',
      'promise_kept',
      'promise_repaired',
      'protocol_version',
      'purge',
      'query_installed_ifelapsed',
      'query_timeout',
      'query_updates_ifelapsed',
      'recognize_join',
      'refresh_processes',
      'repair_denied',
      'repair_failed',
      'repair_timeout',
      'repaired_returncodes',
      'repchar',
      'replace_value',
      'report_changes',
      'report_class_log',
      'report_diffs',
      'report_level',
      'require_comments',
      'rmdeadlinks',
      'rmdirs',
      'rotate',
      'rsize',
      'runagent_socket_allow_users',
      'rxdirs',
      'scan_arrivals',
      'schedule',
      'scope',
      'search_bsdflags',
      'search_groups',
      'search_mode',
      'search_owners',
      'search_size',
      'secureinput',
      'select_end',
      'select_end_match_eof',
      'select_field',
      'select_line_matching',
      'select_line_number',
      'select_multiline_policy',
      'select_start',
      'sensible_count',
      'sensible_size',
      'sensiblecount',
      'sensiblesize',
      'serverfacility',
      'servers',
      'service_args',
      'service_autostart_policy',
      'service_bundle',
      'service_dependence_chain',
      'service_type',
      'site_classes',
      'skipidentify',
      'skipverify',
      'smtpserver',
      'source',
      'specify_default_aces',
      'specify_inherit_aces',
      'splaytime',
      'start_fields_from_zero',
      'status',
      'stealth',
      'stime_range',
      'suspiciousnames',
      'syslog_host',
      'syslog_port',
      'system_log_level',
      'tcpdump',
      'tcpdumpcommand',
      'threads',
      'timeout',
      'timer_policy',
      'timezone',
      'tls_ciphers',
      'tls_min_version',
      'track_growing_file',
      'traverse_links',
      'trustkey',
      'trustkeysfrom',
      'ttime_range',
      'tty',
      'type_check',
      'umask',
      'unmount',
      'update_hashes',
      'useshell',
      'value_separator',
      'verbose',
      'verify',
      'version',
      'vsize',
      'when_linking_children',
      'when_no_source',
      'xdev'
    ],

    special_block_names:
	  [ 'main', '__main__', 'control' ]


  };

  // CFEngine comments start with a hash and go until the end of the line. They can be trailing comments.
  const COMMENT = hljs.COMMENT('#', '$');

  const IDENT_RE = '([A-Za-z_]|::)(\\w|::)*';

  const TITLE = hljs.inherit(hljs.TITLE_MODE, { begin: IDENT_RE });

  const VARIABLE = {
    className: 'variable',
    begin: '\\$' + IDENT_RE
  };

  const STRING = {
    className: 'string',
    contains: [
      hljs.BACKSLASH_ESCAPE,
      VARIABLE
    ],
    variants: [
      {
        begin: /'/,
        end: /'/
      },
      {
        begin: /"/,
        end: /"/
      },
      {
        begin: /`/,
        end: /`/
      }

    ]
  };

  return {
    name: 'CFEngine3',
    aliases: [ 'cf3', 'cfengine', 'cfengine3' ],
    contains: [
      COMMENT,
      VARIABLE,
      STRING,
      {
        beginKeywords: 'bundle',
        end: '\\{|;',
        illegal: /=/,
        contains: [
          TITLE,
          COMMENT
        ]
      },
      {
        beginKeywords: 'body',
        end: '\\{|;',
        illegal: /=/,
        contains: [
          TITLE,
          COMMENT
        ]
      },
      {
        beginKeywords: 'promise',
        end: '\\{|;',
        illegal: /=/,
        contains: [
          TITLE,
          COMMENT
        ]
      },
      {
        begin: '^@if',
        keywords: "if endif",
        end: '^@endif',
        illegal: /=/,
        contains: [
          TITLE,
          COMMENT
        ]
      },
      {
        begin: hljs.IDENT_RE + '\\s+\\{',
        returnBegin: true,
        end: /\S/,
        contains: [
          {
            className: 'keyword',
            begin: hljs.IDENT_RE,
            relevance: 0.2
          },
          {
            begin: /\{/,
            end: /\}/,
            keywords: CFEngine3_KEYWORDS,
            relevance: 0,
            contains: [
              STRING,
              COMMENT,
              {
                begin: '[a-zA-Z_]+\\s*=>',
                returnBegin: true,
                end: '=>',
                contains: [
                  {
                    className: 'attr',
                    begin: hljs.IDENT_RE
                  }
                ]
              },
              {
                className: 'number',
                begin: '(\\b0[0-7_]+)|(\\b0x[0-9a-fA-F_]+)|(\\b[1-9][0-9_]*(\\.[0-9_]+)?)|[0_]\\b',
                relevance: 0
              },
              VARIABLE
            ]
          }
        ],
        relevance: 0
      }
    ]
  };
}
